<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/live/3.0/firebase.js"></script>
<script src="//maps.googleapis.com/maps/api/js?v=3&amp;key=AIzaSyClJ3Ur6zCQQWPtpkHi5WmEx8QWfrI1cgE"></script>
<script src="js/firebase-persistence.js"></script>
<script>
    window.onerror = function (msg, url, lineNo, columnNo, error) {
        alert(msg, url, lineNo, columnNo, error);
      return false;
    };

    function addPlayer(){
        var table = $("#scorecard").find("tbody"),
            newPlayerNumber = table.find("tr").length + 1,
            html = "";
        html += '<tr><td><input id="player' + newPlayerNumber + '" type="text" aria-labelledby="player-label" maxlength="3" name="player-name' + newPlayerNumber + '"></td>';
        for(var i = 1;i<=9;i++){
            html += '<td><input type="number" min="1" max="9" aria-labelledby="player' + newPlayerNumber + ' hole-label hole' + i +'" name="hole' + i +'-' + newPlayerNumber + '"></td>';
        }
        html += '<td><input type="number" min="9" max="81" aria-labelledby="player' + newPlayerNumber + ' total" readonly name="total-' + newPlayerNumber + '"></td>';
        table.append(html);
    }

    function tintScore(el,score){
        score = parseInt(score,10);
        if(score < 3){
            el.removeClass("over-par");
            el.addClass("under-par");
        }
        else if(score > 3){
            el.removeClass("under-par");
            el.addClass("over-par");
        }
        else{
            el.removeClass("over-par");
            el.removeClass("under-par");
        }
    }

    function totalScore(el){
        var score = 0,
            pattern = /\d/,
            row = el.parents("tr"),
            holeFields = row.find("[name^='hole']"),
            totalField = row.find("[name^='total']"),
            thisVal;
        holeFields.each(function(){
            thisVal = $(this).val();
            if(thisVal.match(pattern)){
                score += parseInt(thisVal,10);
            }
        });
        if(score > 0){
            totalField.val(score);
        }
    }

    function validPlayer(el){
        var pattern = /.+/;
        return validateField(el,pattern);
    }

    function validHole(el){
        var pattern = /^\d{1}$/;
        return validateField(el,pattern);
    }

    function validTotal(el){
        var pattern = /^\d{1,2}$/;
        return validateField(el,pattern);
    }

    function validateField(el,pattern){
        var match,
            val = el.val();
        if(typeof val !== "undefined"){
            match = val.match(pattern);
            match ? el.removeClass("invalid") : el.addClass("invalid");
        }
        else{
            match = null;
        }
        return match;
    }

    function submitScores(){
        $("#scorecard").find("tbody").find("tr").each(function(){
            var player,
                total,
                valid = true,
                score = {
                    holes : []
                };
            player = $(this).find("[name^='player']");
            validPlayer(player) ? score.name = player.val() : valid = false;
            total = $(this).find("[name^='total']");
            validTotal(total) ? score.score = total.val() : valid = false;
            $(this).find("[name^='hole']").each(function(){
                validHole($(this)) ? score.holes.push($(this).val()) : valid = false;
            });
            if(valid){
                recordScore(score);
            }
        });
    }

    function addBestScore(score, key, previousKey){
        var tableBody = $("#score-table-body"),
            newRow = '<tr id="' + key + '"><td>' + score.name + '</td>';
        for(var i = 0;i<score.holes.length;i++){
            newRow += '<td>' + score.holes[i] + '</td>';
        }
        newRow += '<td>' + score.score + '</td></tr>';
        previousKey ? $("#" + previousKey).after(newRow) : tableBody.prepend(newRow);
    }

    function removeBestScore(score, key){
        $("#" + key).remove();
    }

    registerForNLowestScores(6, addBestScore, removeBestScore);

    $("#scorecard").on("blur","[name^='hole']",function(){
        validHole($(this));
    });

    $("#scorecard").on("blur","[name^='player']",function(){
        validPlayer($(this));
    });

    $("#scorecard").on("keyup","[name^='hole']",function(){
        var thisScore = $(this).val();
        if(thisScore !== ""){
            tintScore($(this),thisScore);
        }
        totalScore($(this));
    });

    $("#add-player").on("click", function(){
        addPlayer();
    });

    // The following needs to be replaced with a validation process which enables the button once the fields are filled
    $("#submit-scores").prop('disabled', false);
    $("#submit-scores").on("click", function(){
        submitScores();
    });
</script>
<script>
    function map_initialize() {
        var icon = {
            path: "M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0",
            fillColor: '#FF0000',
            fillOpacity: .6,
            anchor: new google.maps.Point(0,0),
            strokeWeight: 0,
            scale: 1
        };

        var icon2 = {
            path: "M 94.955,115.832 100,81.939 l -28.54,0 c 0,0 16.175,-24.743233 16.175,-70.983233 l 7.794981,0 0,-10.60221361 L 4.3836797,0 l 0,10.954767 8.6934273,0 c 0,46.24 15.458893,70.983233 15.458893,70.983233 l -28.536,0 0,0.024 5.041,33.869 35.274699,0 0,55.386 19.718155,0.22 0.353554,-55.606 34.567592,0 z",
            fillColor: '#000000',
            fillOpacity: 0.8,
            anchor: new google.maps.Point(0,0),
            strokeWeight: 0.5,
            strokeColor : "#FFFFFF",
            scale: 0.125
        };

        var golfHoles = [
            {
                name: "Hole One",
                latlng: new google.maps.LatLng(-39.0695346,174.1073713)
            },
            {
                name: "Hole Two",
                latlng: new google.maps.LatLng(-39.0701330,174.1083712)
            },
            {
                name: "Hole Three",
                latlng: new google.maps.LatLng(-39.0702351,174.1080711)
            },
            {
                name: "Hole Four",
                latlng: new google.maps.LatLng(-39.0706656,174.1099710)
            },
            {
                name: "Hole Five",
                latlng: new google.maps.LatLng(-39.0702351,174.1089714)
            },
            {
                name: "Hole Six",
                latlng: new google.maps.LatLng(-39.0698767,174.1087862)
            },
            {
                name: "Hole Seven",
                latlng: new google.maps.LatLng(-39.0706606,174.1073717)
            },
            {
                name: "Hole Eight",
                latlng: new google.maps.LatLng(-39.0706656,174.1088686)
            },
            {
                name: "Hole Nine",
                latlng: new google.maps.LatLng(-39.0695323,174.1094426)
            }
        ];
        var map = new google.maps.Map(document.getElementById("map-container"), {
            center: new google.maps.LatLng(0, 0),
            zoom: 0,
            zoomControl: true,
            mapTypeControl: false,
            scaleControl: false,
            streetViewControl: false,
            rotateControl: false,
            fullscreenControl: false,
            scrollWheel: false,
            mapTypeId: google.maps.MapTypeId.SATELLITE
        });
        for (var i = 0; i < golfHoles.length; i++) {
            new google.maps.Marker({
                position: golfHoles[i].latlng,
                map: map,
                icon: icon2,
                title: golfHoles[i].name
            });
        }
        var latlngbounds = new google.maps.LatLngBounds();
        for (var i = 0; i < golfHoles.length; i++) {
            latlngbounds.extend(golfHoles[i].latlng);
        }
        map.fitBounds(latlngbounds);
        google.maps.event.addDomListener(window, "resize", function() {
            map.fitBounds(latlngbounds);
        });
    }
    google.maps.event.addDomListener(window, 'load', map_initialize);
</script>